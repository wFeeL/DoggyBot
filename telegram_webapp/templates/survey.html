<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="../static/styles.css">
    <script src="../static/survey.js"></script>
    <title>–ê–Ω–∫–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</title>
</head>
<body>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é -->
    <div style="padding: 10px;">
        <a href="/" style="text-decoration: none; color: #667eea; font-weight: bold;">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
    </div>

    <div id="loading" style="text-align: center; padding: 20px;">
        –ó–∞–≥—Ä—É–∑–∫–∞...
    </div>

    <form id="survey_form" style="display: none;">
        <input type="hidden" id="service_id" value="{{ survey_id }}">

        <h2>{{ service_name }}</h2>

        {% if service_description %}
        <div class="service-description">
            {{ service_description | safe }}
        </div>
        {% endif %}

        <div class="options-section">
            {%  if service_options_title %}
            <h3>{{ service_options_title }}</h3>
            {% else %}
            <h3>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–æ–π –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤–∞–º –Ω–∞–∏–±–æ–ª–µ–µ –∞–∫—Ç—É–∞–ª–µ–Ω:</h3>
            {% endif %}

            {% for group in service_option_groups %}
            <div class="option-group">
                {% if group.title %}
                <h4 class="group-title">{{ group.title }}</h4>
                {% endif %}

                {% for option in group.options %}
                <div class="option-card" onclick="selectOption(this)">
                    <input type="radio" id="option_{{ option.id }}" name="selected_option" value="{{ option.id }}" class="option-radio">
                    <label for="option_{{ option.id }}" class="option-label">
                        <span class="option-number">{{ option.formatted_number }}</span>
                        <span class="option-title">{{ option.title }}</span>
                        <span class="option-price">{{ option.price }}</span>
                    </label>

                    {% if option.description %}
                    <div class="option-description">
                        {{ option.description | safe }}
                    </div>
                    {% endif %}

                    {% if option.features %}
                    <div class="option-features">
                        {% for feature in option.features %}
                            {% if feature.startswith('<strong>') %}
                            <div class="feature-header">
                                {{ feature | safe }}
                            </div>
                            {% else %}
                            <div class="feature-item">
                                <span class="feature-bullet">‚Ä¢</span>
                                <span class="feature-text">{{ feature | safe }}</span>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if option.plan %}
                    <div class="option-plan">
                        <strong>‚Äî –ö–∞–∫–æ–π –ø–ª–∞–Ω?</strong>
                        {% for plan_item in option.plan %}
                        <div class="plan-item">{{ plan_item | safe }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if option.link %}
                    <div class="option-link">
                        <a href="{{ option.link.url }}" target="_blank">{{ option.link.text }}</a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endfor %}

            {% if service_footer_link %}
            <div class="footer-link">
                <a href="{{ service_footer_link.url }}" target="_blank">‚¨ÜÔ∏è {{ service_footer_link.text }}</a>
            </div>
            {% endif %}
        </div>

        <div class="free-form-section">
            <div class="free-form-header">
                üôã‚Äç‚ôÄÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–π –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –í–∞–º –∞–∫—Ç—É–∞–ª–µ–Ω –∏ –æ–ø–∏—à–∏—Ç–µ –í–∞—à –∑–∞–ø—Ä–æ—Å –∏ —Å–∏—Ç—É–∞—Ü–∏—é –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ‚Äî —á–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —Ç–µ–º –ª—É—á—à–µ –º—ã —Å–º–æ–∂–µ–º –ø–æ–º–æ—á—å.

                <div class="standard-note">
                    ‚ùî –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –í–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –±—É–¥–µ—Ç –ø–æ–¥–∫—Ä–µ–ø–ª–µ–Ω–∞ –∫ –∑–∞—è–≤–∫–µ.
                </div>

                {% if service_form_note %}
                <div class="additional-notes">
                    {% for note in service_form_note %}
                    <div class="note-item">
                        ‚ùî {{ note }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="entry">
                <label for="selected_option_text">–í—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:</label>
                <input type="text" id="selected_option_text" name="selected_option_text" placeholder="–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞" required readonly>
            </div>

            <div class="entry">
                <label for="free_form">–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏:</label>
                <textarea id="free_form" name="free_form" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é, –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∫–∞–∫ –º–æ–∂–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–µ–µ..." maxlength="2048" required></textarea>
            </div>
        </div>

        <div class="footer-note">
            üòç –ñ–¥—ë–º –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞!
        </div>

        <div class="button submit-button" onclick="submitSurvey()">
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
        </div>
    </form>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É
        function selectOption(card) {
            const radio = card.querySelector('.option-radio');
            radio.checked = true;

            // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            document.querySelectorAll('.option-card').forEach(c => {
                c.classList.remove('selected');
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ
            card.classList.add('selected');

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
            const optionTitle = card.querySelector('.option-title').textContent;
            const optionNumber = card.querySelector('.option-number').textContent;
            document.getElementById('selected_option_text').value = `${optionNumber} ${optionTitle}`;
        }

        // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Web App
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();

            console.log("Telegram Web App initialized");
            console.log("Start param:", Telegram.WebApp.initDataUnsafe.start_param);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('survey_form').style.display = 'block';
        } else {
            setTimeout(function() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('survey_form').style.display = 'block';
            }, 1000);
        }
    </script>
</body>
</html>